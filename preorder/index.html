<script>
  document.addEventListener("DOMContentLoaded", () => {
    const preorderBtn = document.getElementById('preorder-button');
    const inventoryLabel = document.getElementById('inventory-count');

    if (inventoryLabel) {
      fetch('https://chatrbox-backend.onrender.com/remaining-count')
        .then(res => res.json())
        .then(data => {
          inventoryLabel.textContent = `Only ${data.remaining} of 500 ChatrBoxes Remaining`;
        })
        .catch(err => {
          console.error('Inventory fetch error:', err);
          inventoryLabel.textContent = "Inventory unavailable.";
        });
    }

    if (preorderBtn) {
      preorderBtn.addEventListener('click', async () => {
        if (!sessionStorage.getItem('chatrbox_ordered')) {
          try {
            const res = await fetch('https://chatrbox-backend.onrender.com/decrement-count', {
              method: 'POST'
            });
            const data = await res.json();
            if (inventoryLabel) {
              inventoryLabel.textContent = `Only ${data.remaining} of 500 ChatrBoxes Remaining`;
            }
            sessionStorage.setItem('chatrbox_ordered', 'true');
          } catch (err) {
            console.error('Inventory decrement failed:', err);
          }
        }

        preorderBtn.disabled = true;
        preorderBtn.textContent = 'Redirecting...';
        preorderBtn.style.opacity = '0.6';

        try {
          const res = await fetch('https://chatrbox-backend.onrender.com/create-checkout-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          const data = await res.json();
          if (data.url) {
            window.location.href = data.url;
          } else {
            throw new Error('No Stripe URL returned');
          }
        } catch (err) {
          console.error('❌ Stripe checkout error:', err);
          alert('Something went wrong. Please try again later.');
          preorderBtn.disabled = false;
          preorderBtn.textContent = 'Pre-Order Now';
          preorderBtn.style.opacity = '1';
        }
      });
    }

    const notifyForm = document.getElementById('notifyForm');
    if (notifyForm) {
      notifyForm.addEventListener('submit', function (e) {
        e.preventDefault();
        const form = this;
        const email = form.email.value;
        const button = form.querySelector('button');

        button.disabled = true;
        button.textContent = 'Submitting...';
        button.style.opacity = '0.6';

        fetch("https://script.google.com/macros/s/AKfycbygB9yzT7ObQlPzqVvQXmtcRjwYCVcHZHiaEDeGm3gDnCHIQJMaYYy4QIKX8l6qksY/exec", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "email=" + encodeURIComponent(email)
        })
          .then(res => res.text())
          .then(response => {
            if (response === "Success") {
              alert("Thanks! You’ll be notified at: " + email);
              form.reset();
            } else {
              alert("Error: " + response);
            }
          })
          .catch(err => alert("Something went wrong. Please try again."))
          .finally(() => {
            button.disabled = false;
            button.textContent = 'Notify Me';
            button.style.opacity = '1';
          });
      });
    }
  });
</script>
