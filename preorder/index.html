<script>
  // Stripe Checkout integration
  document.getElementById('preorder-button').addEventListener('click', async () => {
    const button = document.getElementById('preorder-button');
    button.disabled = true;
    button.textContent = 'Redirecting...';
    button.style.opacity = '0.6';

    try {
      const res = await fetch('https://chatrbox-backend.onrender.com/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const data = await res.json();
      if (data.url) {
        window.location.href = data.url;
      } else {
        throw new Error('No URL returned');
      }
    } catch (err) {
      console.error('❌ Stripe checkout error:', err);
      alert('Something went wrong. Please try again later.');
      button.disabled = false;
      button.textContent = 'Pre-Order Now';
      button.style.opacity = '1';
    }
  });

  // Google Sheets "Notify Me" integration
  document.getElementById('notifyForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const form = this;
    const email = form.email.value;
    const button = form.querySelector('button');

    button.disabled = true;
    button.textContent = 'Submitting...';
    button.style.opacity = '0.6';

    fetch("https://script.google.com/macros/s/AKfycbygB9yzT7ObQlPzqVvQXmtcRjwYCVcHZHiaEDeGm3gDnCHIQJMaYYy4QIKX8l6qksY/exec", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: "email=" + encodeURIComponent(email)
    })
    .then(res => res.text())
    .then(response => {
      if (response === "Success") {
        alert("Thanks! You’ll be notified at: " + email);
        form.reset();
      } else {
        alert("Error: " + response);
      }
    })
    .catch(err => alert("Something went wrong. Please try again."))
    .finally(() => {
      button.disabled = false;
      button.textContent = 'Notify Me';
      button.style.opacity = '1';
    });
  });

  // Inventory Counter Script
  document.addEventListener("DOMContentLoaded", () => {
    // Load current count
    fetch('https://chatrbox-backend.onrender.com/remaining-count')
      .then(res => res.json())
      .then(data => {
        document.getElementById('inventory-count').textContent =
          `Only ${data.remaining} of 500 ChatrBoxes Remaining`;
      })
      .catch(err => {
        console.error('Inventory fetch error:', err);
        document.getElementById('inventory-count').textContent = "Inventory unavailable.";
      });

    // Decrement on first click only
    if (!sessionStorage.getItem('chatrbox_ordered')) {
      document.getElementById('preorder-button').addEventListener('click', async () => {
        try {
          const res = await fetch('https://chatrbox-backend.onrender.com/decrement-count', {
            method: 'POST'
          });
          const data = await res.json();
          document.getElementById('inventory-count').textContent =
            `Only ${data.remaining} of 500 ChatrBoxes Remaining`;
          sessionStorage.setItem('chatrbox_ordered', 'true');
        } catch (err) {
          console.error('Inventory decrement failed:', err);
        }
      });
    }
  });
</script>



